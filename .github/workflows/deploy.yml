name: Deploy ESP32 Site

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create data file
        run: echo '{"lastUpdated":"2024-01-01T00:00:00.000Z","messages":[]}' > data.json

      - name: Create HTML step by step
        run: |
          # ä½¿ç”¨å¤šä¸ªechoå‘½ä»¤åˆ›å»ºHTMLï¼Œé¿å…å¤šè¡Œæ–‡æœ¬
          echo '<!DOCTYPE html>' > index.html
          echo '<html>' >> index.html
          echo '<head>' >> index.html
          echo '<title>ESP32æ•°æ®ç›‘æ§</title>' >> index.html
          echo '<style>' >> index.html
          echo 'body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }' >> index.html
          echo '.header { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }' >> index.html
          echo '.message { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; background-color: white; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }' >> index.html
          echo '.timestamp { color: #666; font-size: 0.9em; margin-bottom: 8px; }' >> index.html
          echo '.data-item { margin: 3px 0; font-family: monospace; }' >> index.html
          echo '.refresh-btn { padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 15px; }' >> index.html
          echo '.stats { display: flex; gap: 20px; margin: 15px 0; }' >> index.html
          echo '.stat-item { background: #e9ecef; padding: 8px 12px; border-radius: 4px; font-size: 0.9em; }' >> index.html
          echo '.last-updated { color: #6c757d; font-size: 0.8em; margin-top: 10px; }' >> index.html
          echo '</style>' >> index.html
          echo '</head>' >> index.html
          echo '<body>' >> index.html
          echo '<div class="header">' >> index.html
          echo '<h1>ğŸ“¡ ESP32æ•°æ®æ¥æ”¶å†å²</h1>' >> index.html
          echo '<div class="stats">' >> index.html
          echo '<div class="stat-item">æ€»æ•°æ®é‡: <span id="totalCount">0</span> æ¡</div>' >> index.html
          echo '<div class="stat-item">æœ€æ–°æ•°æ®: <span id="latestTime">-</span></div>' >> index.html
          echo '</div>' >> index.html
          echo '<button class="refresh-btn" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>' >> index.html
          echo '<div class="last-updated">æœ€åæ›´æ–°: <span id="lastUpdated">-</span></div>' >> index.html
          echo '</div>' >> index.html
          echo '<div id="data"></div>' >> index.html
          echo '<script>' >> index.html
          echo 'const DATA_URL = "./data.json";' >> index.html
          echo 'async function loadData() {' >> index.html
          echo '  try {' >> index.html
          echo '    document.getElementById("data").innerHTML = "<p>åŠ è½½ä¸­...</p>";' >> index.html
          echo '    const url = DATA_URL + "?t=" + new Date().getTime();' >> index.html
          echo '    const response = await fetch(url);' >> index.html
          echo '    if (!response.ok) throw new Error("åŠ è½½å¤±è´¥: " + response.status);' >> index.html
          echo '    const data = await response.json();' >> index.html
          echo '    document.getElementById("lastUpdated").textContent = new Date(data.lastUpdated).toLocaleString();' >> index.html
          echo '    document.getElementById("totalCount").textContent = data.messages.length;' >> index.html
          echo '    if (data.messages.length > 0) {' >> index.html
          echo '      document.getElementById("latestTime").textContent = data.messages[0].timestamp;' >> index.html
          echo '    }' >> index.html
          echo '    displayData(data.messages);' >> index.html
          echo '  } catch (error) {' >> index.html
          echo '    document.getElementById("data").innerHTML = "<div style=\"color: red; padding: 10px;\">âŒ åŠ è½½å¤±è´¥: " + error.message + "</div>";' >> index.html
          echo '  }' >> index.html
          echo '}' >> index.html
          echo 'function displayData(messages) {' >> index.html
          echo '  const container = document.getElementById("data");' >> index.html
          echo '  if (messages.length === 0) {' >> index.html
          echo '    container.innerHTML = "<div style=\"text-align: center; padding: 40px; color: #666;\">æš‚æ— æ•°æ®ï¼Œç­‰å¾…ESP32å‘é€æ•°æ®...</div>";' >> index.html
          echo '    return;' >> index.html
          echo '  }' >> index.html
          echo '  let html = "";' >> index.html
          echo '  for (const msg of messages) {' >> index.html
          echo '    html += "<div class=\"message\"><div class=\"timestamp\">ğŸ“… " + msg.timestamp + "</div><div class=\"data-content\">";' >> index.html
          echo '    for (const [key, value] of Object.entries(msg.data)) {' >> index.html
          echo '      html += "<div class=\"data-item\"><strong>" + key + ":</strong> " + value + "</div>";' >> index.html
          echo '    }' >> index.html
          echo '    html += "</div></div>";' >> index.html
          echo '  }' >> index.html
          echo '  container.innerHTML = html;' >> index.html
          echo '}' >> index.html
          echo 'document.addEventListener("DOMContentLoaded", loadData);' >> index.html
          echo 'setInterval(loadData, 30000);' >> index.html
          echo '</script>' >> index.html
          echo '</body>' >> index.html
          echo '</html>' >> index.html

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
