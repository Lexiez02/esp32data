name: Deploy ESP32 Site

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Fetch data from Gist
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # 从Gist获取数据
          curl -H "Authorization: token $GH_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/gists/$GIST_ID" > gist_data.json
          
          # 处理数据
          node -e "
          const fs = require('fs');
          try {
            const gist = JSON.parse(fs.readFileSync('gist_data.json', 'utf8'));
            const filename = Object.keys(gist.files)[0];
            const messages = JSON.parse(gist.files[filename].content);
            
            const frontendData = {
              lastUpdated: new Date().toISOString(),
              messages: messages.slice(0, 50)
            };
            
            fs.writeFileSync('data.json', JSON.stringify(frontendData, null, 2));
            console.log('成功获取 ' + messages.length + ' 条数据');
          } catch (error) {
            console.error('处理数据失败:', error);
            const emptyData = {
              lastUpdated: new Date().toISOString(),
              messages: []
            };
            fs.writeFileSync('data.json', JSON.stringify(emptyData, null, 2));
            console.log('创建空数据文件');
          }
          "

      - name: Create HTML file step by step
        run: |
          # 逐步创建HTML文件，避免多行文本问题
          echo '<!DOCTYPE html>' > index.html
          echo '<html>' >> index.html
          echo '<head>' >> index.html
          echo '<title>ESP32数据监控</title>' >> index.html
          echo '<style>' >> index.html
          echo 'body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }' >> index.html
          echo '.header { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }' >> index.html
          echo '.message { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; background-color: white; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }' >> index.html
          echo '.timestamp { color: #666; font-size: 0.9em; margin-bottom: 8px; }' >> index.html
          echo '.data-item { margin: 3px 0; font-family: monospace; }' >> index.html
          echo '.refresh-btn { padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 15px; }' >> index.html
          echo '.stats { display: flex; gap: 20px; margin: 15px 0; }' >> index.html
          echo '.stat-item { background: #e9ecef; padding: 8px 12px; border-radius: 4px; font-size: 0.9em; }' >> index.html
          echo '.last-updated { color: #6c757d; font-size: 0.8em; margin-top: 10px; }' >> index.html
          echo '</style>' >> index.html
          echo '</head>' >> index.html
          echo '<body>' >> index.html
          echo '<div class="header">' >> index.html
          echo '<h1>📡 ESP32数据接收历史</h1>' >> index.html
          echo '<div class="stats">' >> index.html
          echo '<div class="stat-item">总数据量: <span id="totalCount">0</span> 条</div>' >> index.html
          echo '<div class="stat-item">最新数据: <span id="latestTime">-</span></div>' >> index.html
          echo '</div>' >> index.html
          echo '<button class="refresh-btn" onclick="loadData()">🔄 刷新数据</button>' >> index.html
          echo '<div class="last-updated">最后更新: <span id="lastUpdated">-</span></div>' >> index.html
          echo '</div>' >> index.html
          echo '<div id="data"></div>' >> index.html
          echo '<script>' >> index.html
          echo 'const DATA_URL = "./data.json";' >> index.html
          echo 'async function loadData() {' >> index.html
          echo '  try {' >> index.html
          echo '    document.getElementById("data").innerHTML = "<p>加载中...</p>";' >> index.html
          echo '    const url = DATA_URL + "?t=" + new Date().getTime();' >> index.html
          echo '    const response = await fetch(url);' >> index.html
          echo '    if (!response.ok) throw new Error("加载失败: " + response.status);' >> index.html
          echo '    const data = await response.json();' >> index.html
          echo '    document.getElementById("lastUpdated").textContent = new Date(data.lastUpdated).toLocaleString();' >> index.html
          echo '    document.getElementById("totalCount").textContent = data.messages.length;' >> index.html
          echo '    if (data.messages.length > 0) {' >> index.html
          echo '      document.getElementById("latestTime").textContent = data.messages[0].timestamp;' >> index.html
          echo '    }' >> index.html
          echo '    displayData(data.messages);' >> index.html
          echo '  } catch (error) {' >> index.html
          echo '    document.getElementById("data").innerHTML = "<div style=\"color: red; padding: 10px;\">❌ 加载失败: " + error.message + "</div>";' >> index.html
          echo '  }' >> index.html
          echo '}' >> index.html
          echo 'function displayData(messages) {' >> index.html
          echo '  const container = document.getElementById("data");' >> index.html
          echo '  if (messages.length === 0) {' >> index.html
          echo '    container.innerHTML = "<div style=\"text-align: center; padding: 40px; color: #666;\">暂无数据，等待ESP32发送数据...</div>";' >> index.html
          echo '    return;' >> index.html
          echo '  }' >> index.html
          echo '  container.innerHTML = messages.map(msg =>' >> index.html
          echo '    "<div class=\"message\"><div class=\"timestamp\">📅 " + msg.timestamp + "</div><div class=\"data-content\">" + formatData(msg.data) + "</div></div>"' >> index.html
          echo '  ).join("");' >> index.html
          echo '}' >> index.html
          echo 'function formatData(data) {' >> index.html
          echo '  let html = "";' >> index.html
          echo '  for (const [key, value] of Object.entries(data)) {' >> index.html
          echo '    html += "<div class=\"data-item\"><strong>" + key + ":</strong> " + value + "</div>";' >> index.html
          echo '  }' >> index.html
          echo '  return html;' >> index.html
          echo '}' >> index.html
          echo 'document.addEventListener("DOMContentLoaded", loadData);' >> index.html
          echo 'setInterval(loadData, 30000);' >> index.html
          echo '</script>' >> index.html
          echo '</body>' >> index.html
          echo '</html>' >> index.html

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
