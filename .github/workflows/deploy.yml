name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Fetch data from Gist
      env:
        GIST_ID: ${{ secrets.GIST_ID }}
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        # 从Gist获取数据
        curl -H "Authorization: token $GH_TOKEN" \
             -H "Accept: application/vnd.github.v3+json" \
             "https://api.github.com/gists/$GIST_ID" > gist_data.json
        
        # 处理数据
        node -e "
        const fs = require('fs');
        try {
          const gist = JSON.parse(fs.readFileSync('gist_data.json', 'utf8'));
          const filename = Object.keys(gist.files)[0];
          const messages = JSON.parse(gist.files[filename].content);
          
          const frontendData = {
            lastUpdated: new Date().toISOString(),
            messages: messages.slice(0, 50)
          };
          
          fs.writeFileSync('data.json', JSON.stringify(frontendData, null, 2));
          console.log('成功获取 ' + messages.length + ' 条数据');
        } catch (error) {
          console.error('处理数据失败:', error);
          // 创建空数据文件
          const emptyData = {
            lastUpdated: new Date().toISOString(),
            messages: []
          };
          fs.writeFileSync('data.json', JSON.stringify(emptyData, null, 2));
          console.log('创建空数据文件');
        }
        "
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
